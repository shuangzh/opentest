package cmsz.rd.opentest.file.creator;

import cmsz.rd.opentest.exceptions.ParamValidException;
import cmsz.rd.opentest.file.validator.Field;
import com.thoughtworks.xstream.XStream;

import java.io.*;
import java.util.ArrayList;
import java.util.List;

/**
 * Created by admin on 2017/4/14.
 */

/**
 * 文件生产器
 */
public class Creator {

    /**
     * 行配置Lineconf
     */
    private LineConf lineConf = new LineConf();

    /**
     * 数据存储在List<lineConf> datas中
     */
    private List<LineConf> datas = new ArrayList<>();

    /**
     * 判断lineconf是否更新了，如果lineConfUpdated为真，则表示Lineconf进行了更新
     */
    private boolean lineConfUpdated;

    public void setLineConfUpdated(boolean lineConfUpdated) {
        this.lineConfUpdated = lineConfUpdated;
    }


    public void xmlLineConf(String xml) {
        XStream xs = new XStream();
        xs.setMode(XStream.NO_REFERENCES);
        xs.processAnnotations(LineConf.class);
        InputStream in = new ByteArrayInputStream(xml.getBytes());

        LineConf lineConf = (LineConf) xs.fromXML(in);
        this.lineConf = lineConf;
        this.lineConfUpdated = true;
    }

    /**
     * 追加数据
     * @param i
     */
    public void append(int i) {
        if (i > 0) {
            for (int k = 0; k < i; k++) {
                // 如果lineconf更新了，表示是新配置行，直接追加新配置行
                if (lineConfUpdated) {
                    LineConf n = (LineConf) this.lineConf.clone();
                    datas.add(n);
                    lineConfUpdated = false;
                } else {
                    // lineconf没有更新，则lineConf计算value的下一个值，并追加到datas中
                    lineConf.next();
                    LineConf nn = (LineConf) this.lineConf.clone();
                    datas.add(nn);
                }
            }
        }
    }

    /**
     * 从rowIndex行开始，删除count行
     * @param rowindex
     * @param count
     */
    synchronized  public void remove(int rowindex, int count){
        rowindex = rowindex -1;
        for(int i=0; i<count; i++){
            if(datas.size() > rowindex) {
                datas.remove(rowindex);
            }
        }
    }

    /**
     * 返回数据总行数
     * @return
     */
    public int rowCount() {
        return datas.size();
    }

    /**
     * 从rowIndex行开始，插入count行
     * @param rowindex
     * @param count
     */
    synchronized public void insert(int rowindex, int count){
        rowindex = rowindex -1;
        if(rowindex > datas.size() )
            throw new IndexOutOfBoundsException("insert index out of  file length");

        if(count > 0){
            for (int k = 0; k < count; k++) {
                if (lineConfUpdated) {
                    LineConf n = (LineConf) this.lineConf.clone();
                    datas.add(rowindex, n);
                    lineConfUpdated = false;
                } else {
                    lineConf.next();
                    LineConf nn = (LineConf) this.lineConf.clone();
                    datas.add(rowindex, nn);
                }
                rowindex++;
            }
        }
    }

    /**
     * 在前台打印出文件内容
     */
    public void print() {
        for (LineConf lc : datas) {
            System.out.println(lc.assemble());
        }
    }

    /**
     * 创建本地文件
     * @param filepath  本地文件路径
     * @return  File 本地文件的File对象
     */
    public File createFile(String filepath){
        File file = new File(filepath);
        File parent = file.getParentFile();

        if(!parent.exists()){
            parent.mkdirs();
        }
        if(!file.exists()){
            try {
                file.createNewFile();
            } catch (IOException e) {
                e.printStackTrace();
                throw  new RuntimeException("Create file failed:"+ filepath, e);
            }
        }
        try {
            PrintWriter pw=new PrintWriter(file);
            for (LineConf lc : datas) {
                pw.println(lc.assemble());
            }
            pw.close();
        } catch (FileNotFoundException e) {
            e.printStackTrace();
            throw new RuntimeException("Open file failed:"+ filepath, e);
        } catch (IOException e) {
            e.printStackTrace();
            throw new RuntimeException("Write to file failed:"+filepath, e);
        }
        return file;
    }

    public LineConf getLineConf() {
        return lineConf;
    }

    public void setLineConf(LineConf lineConf) {
        this.lineConf = lineConf;
    }

    public List<LineConf> getDatas() {
        return  datas;
    }

    /**
     * 修改datas中的FieldConf
     * @param rowIndex
     * @param columIndex
     * @param param
     */
    private void modify(int rowIndex, int columIndex, String[] param)
    {
        rowIndex = rowIndex -1;
        columIndex = columIndex -1;
        LineConf lineConf = datas.get(rowIndex);
        FieldConf fieldConf=lineConf.getFields().get(columIndex);
        if (param == null || param.length < 3)
            throw new ParamValidException();
        fieldConf.setName(param[0]);
        fieldConf.setFormat(param[1]);
        fieldConf.setValue(param[2]);
        if (param.length >= 4)
            fieldConf.setGen(param[3]);

        if (param.length >= 5)
            fieldConf.setLen(Integer.parseInt(param[4]));
        if (param.length >= 7) {
            fieldConf.setP1(Integer.parseInt(param[5]));
            fieldConf.setP2(Integer.parseInt(param[6]));
        }
    }

    /**
     * 修改Datas 中的fileConf值
     * @param rowIndex      行号
     * @param fieldname     字段名
     * @param value         新值
     */
    public void modifyValue(int rowIndex, String fieldname, String value){
        rowIndex = rowIndex -1;
        LineConf lineConf = datas.get(rowIndex);
        List<FieldConf> list = lineConf.getFields();
        for(FieldConf c: list){
            if(c.getName().compareToIgnoreCase(fieldname)==0){
                c.setValue(value);
                return;
            }
        }
    }

    /**
     * 获取datas中的rowIndex行的filename字段值
     * @param rowIndex
     * @param fieldname
     * @return
     */
    public String getValue(int rowIndex, String fieldname){
        rowIndex = rowIndex -1;
        LineConf lineConf = datas.get(rowIndex);
        List<FieldConf> list = lineConf.getFields();
        for(FieldConf c : list){
            if(c.getName().compareToIgnoreCase(fieldname)==0){
                c.getValue();
            }
        }
        return  null;
    }

}
