/**
 * louiszhang
 *上午11:03:35
 */
package com.cmsz.cmup.fileImporting.handler.impl;

import java.util.Map;

import javax.annotation.Resource;

import org.springframework.stereotype.Component;

import com.cmsz.cmup.commons.ftp.FtpClientUtil;
import com.cmsz.cmup.commons.logging.alarm.AlarmLogHandler;
import com.cmsz.cmup.commons.logging.mapper.AlarmLogBeanMapper;
import com.cmsz.cmup.commons.logging.system.SystemLogHandler;
import com.cmsz.cmup.commons.utils.DateUtil;
import com.cmsz.cmup.fileImporting.constant.FileHandleConstant;
import com.cmsz.cmup.fileImporting.dao.FileStatusDAO;
import com.cmsz.cmup.fileImporting.handler.Handler;

/**
 * handler for files directly transporting(文件透传功能处理类)
 * 
 * @author louiszhang
 * @time 20162016年8月15日上午11:03:35
 */
@Component
public class FileDirectTransHandler implements Handler {
	private static SystemLogHandler systemLogger = SystemLogHandler.getLogger(FileDirectTransHandler.class);
	private static AlarmLogHandler alarmLogger = AlarmLogHandler.getLogger(FileDirectTransHandler.class);

	@Resource
	FtpClientUtil ftpClientUtil;
	@Resource
	FileStatusDAO fileStatusDAO;
	@Resource
	AlarmLogBeanMapper alarmLogBeanMapper;

	@Override
	public Map<String, String> handle(Map<String, String> variableMap) throws Exception {
		String errmsg;

		errmsg = variableMap.get(FileHandleConstant.FILE_NAME) + ";"
				+ variableMap.get(FileHandleConstant.FILE_TYPE_DESC)
				+ " file;Start to transport the file from FTP server..." + "(" + "文件开始通过FTP透传..." + ")";
		systemLogger.info(errmsg, variableMap);

		// 透传下发目录
		String outgoingPath = variableMap.get(FileHandleConstant.OUT_GOING_PATH);
		// 文件路径（带加时间戳的文件名）
		String filePathName = variableMap.get(FileHandleConstant.FILE_PATH);
		// 获取文件的备份文件路径（已无ftp根目录,截去文件名）
		String srcPath = filePathName.substring(0, filePathName.lastIndexOf("/"));
		// 文件复制到下发目录的存放路径
		String destPath = outgoingPath + "/" + DateUtil.getDateyyyyMMdd();
		// 截取备份目录下文件名，带时间戳
		String srcName = variableMap.get(FileHandleConstant.FILE_NAME);
		// 文件复制到下发路径的文件名，不带时间戳
		String destName = srcName.substring(0, srcName.lastIndexOf("_"));

		try {
			ftpClientUtil.copy(srcPath, destPath, srcName, ".doing", destName);
		} catch (Exception e) {
			errmsg = variableMap.get(FileHandleConstant.FILE_NAME) + ";"
					+ variableMap.get(FileHandleConstant.FILE_TYPE_DESC)
					+ " file;Exception happend while transporting the file directly from FTP server..." + "("
					+ "文件远程FTP透传出现错误..." + ")";
			systemLogger.error(errmsg, variableMap, e);
			alarmLogger.error(errmsg, variableMap, e);
			throw e;
		}

		return variableMap;
	}

}
